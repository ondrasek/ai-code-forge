name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:


jobs:
  validate-versions:
    name: Version Consistency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Make validation script executable
        run: chmod +x scripts/validate-versions.sh

      - name: Run version consistency validation
        run: |
          ./scripts/validate-versions.sh

  build-and-test:
    name: Build and Test CLI Package
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('cli/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Clean up dist (should be empty)
        run: |
          # We must make sure that we are not touching dist in the repo root, but the one in cli.
          test -d cli/dist && rm -rfv cli/dist
          mkdir -p cli/dist

      - name: Build CLI package with templates
        run: |
          cd cli
          # Use custom build script to properly bundle templates
          ./build-with-templates.sh

      - name: Validate package
        run: |
          cd cli

          # Check if artifacts were created using proper file checks
          if ls dist/*.whl >/dev/null 2>&1; then
            echo "âœ… Wheel file created successfully"
            WHEEL_FILE=$(ls dist/*.whl | head -1)
            echo "Wheel: $WHEEL_FILE"
          else
            echo "âŒ No wheel file found"
            exit 1
          fi

          if ls dist/*.tar.gz >/dev/null 2>&1; then
            echo "âœ… Source distribution created successfully"
            TAR_FILE=$(ls dist/*.tar.gz | head -1)
            echo "Source dist: $TAR_FILE"
          else
            echo "âŒ No source distribution found"
            exit 1
          fi

          # Test package import
          echo "Testing package import..."
          if uv run python -c "import ai_code_forge_cli; print('âœ… Package imports successfully')"; then
            echo "âœ… Package validation passed"
          else
            echo "âŒ Package validation failed"
            exit 1
          fi

      - name: Run tests
        run: |
          cd cli
          uv run pytest --verbose --tb=short
          echo "âœ… Tests completed"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-build-artifacts-${{ github.sha }}
          path: cli/dist/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-test-results-${{ github.sha }}
          path: cli/.pytest_cache/
          retention-days: 7

  test-mcp-servers:
    name: Test MCP Servers
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install MCP server dependencies
        run: |
          cd mcp-servers
          python -m pip install --upgrade pip
          # Install test dependencies if requirements exist
          if [ -f tests/requirements.txt ]; then
            pip install -r tests/requirements.txt
          fi
          # Install each MCP server's dependencies
          for server_dir in */; do
            if [ -f "$server_dir/pyproject.toml" ]; then
              echo "Installing dependencies for $server_dir"
              cd "$server_dir"
              pip install -e .
              cd ..
            fi
          done

      - name: Run MCP server tests
        run: |
          cd mcp-servers
          chmod +x tests/run_tests.sh
          ./tests/run_tests.sh --env ci

  test-scripts:
    name: Test Scripts
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Make test scripts executable
        run: |
          chmod +x scripts/tests/*.sh

      - name: Run script tests
        run: |
          cd scripts/tests
          ./run-all-tests.sh --verbose

  build-summary:
    name: CI Summary
    needs: [validate-versions, build-and-test, test-mcp-servers, test-scripts]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate CI summary
        run: |
          echo "## ðŸ” Continuous Integration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Version validation status
          if [[ "${{ needs.validate-versions.result }}" == "success" ]]; then
            echo "âœ… **Version Consistency:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Version Consistency:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Build and test status
          if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
            echo "âœ… **Build & Test:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build & Test:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # MCP server tests status
          if [[ "${{ needs.test-mcp-servers.result }}" == "success" ]]; then
            echo "âœ… **MCP Server Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **MCP Server Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Script tests status
          if [[ "${{ needs.test-scripts.result }}" == "success" ]]; then
            echo "âœ… **Script Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Script Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ What Was Validated:" >> $GITHUB_STEP_SUMMARY
          echo "- Version consistency across all pyproject.toml and __init__.py files" >> $GITHUB_STEP_SUMMARY
          echo "- CLI package builds successfully with templates" >> $GITHUB_STEP_SUMMARY
          echo "- Package imports work correctly" >> $GITHUB_STEP_SUMMARY
          echo "- CLI unit tests pass" >> $GITHUB_STEP_SUMMARY
          echo "- MCP server functionality and integration tests" >> $GITHUB_STEP_SUMMARY
          echo "- Script launcher and worktree integration tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.validate-versions.result }}" == "success" && "${{ needs.build-and-test.result }}" == "success" && "${{ needs.test-mcp-servers.result }}" == "success" && "${{ needs.test-scripts.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **Overall Status:** All checks passed - ready for release!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Overall Status:** Some checks failed - review before release" >> $GITHUB_STEP_SUMMARY
          fi