#!/bin/bash

# Configure worktree commands for bash shell
set -e

echo "üêö Configuring bash worktree commands..."

# Environment variables are loaded by postCreate.sh and exported to child processes

# Note: This modifies bash profile within the DevContainer environment only.
# The modifications are isolated to the container and do not affect the host system.

# Validate working copy directory and worktree script existence
if [[ -z "$workingCopy" ]]; then
    echo "‚ö†Ô∏è Working copy path not set, skipping bash worktree initialization"
    exit 0
elif [[ ! -d "$workingCopy" ]]; then
    echo "‚ö†Ô∏è Working copy directory not found: $workingCopy, skipping bash worktree initialization"
    exit 0
elif [[ ! -x "$workingCopy/scripts/worktree/worktree.sh" ]]; then
    echo "‚ö†Ô∏è Worktree script not found or not executable, skipping bash worktree initialization"
    exit 0
fi

cd "$workingCopy"

# Check if worktree configuration already exists to prevent duplicates
if ! grep -q "Git Worktree Management - Generated by worktree.sh init for bash" ~/.bashrc 2>/dev/null; then
    echo "Adding worktree configuration to bash profile..."
    # Only redirect stdout to bashrc, let stderr go to terminal to avoid ANSI sequences in RC files
    if ./scripts/worktree/worktree.sh init --shell bash >> ~/.bashrc; then
        echo "‚úÖ Bash worktree configuration added"
    else
        echo "‚ö†Ô∏è Failed to initialize worktree for bash"
        exit 1
    fi
else
    echo "‚úÖ Bash worktree configuration already exists"
fi

cd -
echo "‚úÖ Bash worktree configuration completed"